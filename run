#!/bin/bash

# Simple run script for Replit deployment
# This is the entry point for the application

set -e

LOG_PREFIX="[RUN]"
log() {
    echo "$LOG_PREFIX $1" >&2
}

log "=== Spring Boot Deployment Build ==="
log "Timestamp: $(date)"

echo "=== Twitch Chat Reader Deployment ==="
echo "Timestamp: $(date)"

log "Setting up Java environment..."

# Find Java installation
JAVA_HOME=""
NIX_JAVA=$(ls -d /nix/store/*jdk* 2>/dev/null | head -1)
if [ -n "$NIX_JAVA" ] && [ -d "$NIX_JAVA" ]; then
    JAVA_HOME="$NIX_JAVA"
    log "Found Java in Nix store: $JAVA_HOME"
elif [ -d "/usr/lib/jvm/java-11-openjdk" ]; then
    JAVA_HOME="/usr/lib/jvm/java-11-openjdk"
    log "Found Java in system: $JAVA_HOME"
elif [ -d "/usr/lib/jvm/default-java" ]; then
    JAVA_HOME="/usr/lib/jvm/default-java"
    log "Found Java in system: $JAVA_HOME"
else
    log "ERROR: No Java installation found"
    exit 1
fi

export JAVA_HOME
export PATH="$JAVA_HOME/bin:$PWD/maven/bin:$PATH"
echo "✓ Java environment set: $JAVA_HOME"


# Verify Java is working
if ! command -v java >/dev/null 2>&1; then
    echo "ERROR: Java command not available after setup"
    exit 1
fi

echo "✓ Java version: $(java -version 2>&1 | head -1)"

# Find the JAR file
JAR_FILE="target/twitch-chat-reader-1.0.0.jar"
if [ ! -f "$JAR_FILE" ]; then
    JAR_FILE="target/twitch-chat-reader-1.0.jar"
fi

if [ ! -f "$JAR_FILE" ]; then
    echo "[RUN] ERROR: JAR file not found. Building first..."
    if [ -d "maven" ]; then
        export PATH="$PWD/maven/bin:$PATH"
        mvn clean package -DskipTests -q
        if [ ! -f "$JAR_FILE" ]; then
            echo "[RUN] ERROR: Build failed"
            exit 1
        fi
    else
        echo "[RUN] ERROR: No Maven found and no JAR file present"
        exit 1
    fi
fi

echo "[RUN] ✓ JAR file found: $JAR_FILE"

# Start the application
echo "[RUN] Starting Spring Boot application..."
java -jar "$JAR_FILE" --server.port=5000