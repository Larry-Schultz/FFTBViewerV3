#!/bin/bash

# Simple run script for Replit deployment
# This is the entry point for the application

set -e

LOG_PREFIX="[RUN]"
log() {
    echo "$LOG_PREFIX $1" >&2
}

log "=== Spring Boot Deployment Build ==="
log "Timestamp: $(date)"

echo "=== Twitch Chat Reader Deployment ==="
echo "Timestamp: $(date)"


# Check if JAVA_HOME is populated
if [ -z "$JAVA_HOME" ]; then
    log "ERROR: JAVA_HOME not set"
    
    log "Java not found, attempting to download"
    if [ ! -d "jdk-11" ]; then
        log "Downloading OpenJDK 11..."
        curl -L -o openjdk-11.tar.gz https://github.com/AdoptOpenJDK/openjdk11-binaries/releases/download/jdk-11+28/OpenJDK11U-jdk_x64_linux_hotspot_11_28.tar.gz
        tar -xzf openjdk-11.tar.gz
        mv jdk-11+28 jdk-11
        rm openjdk-11.tar.gz
        export JAVA_HOME="$PWD/jdk-11"
        export PATH="$JAVA_HOME/bin:$PATH"
        log "Java installed and JAVA_HOME set: $JAVA_HOME"
    else
        log "OpenJDK 11 already downloaded."
        export JAVA_HOME="$PWD/jdk-11"
        export PATH="$JAVA_HOME/bin:$PATH"
        log "JAVA_HOME set: $JAVA_HOME"
    fi
        exit 1
    fi
fi


echo "✓ Java environment set: $JAVA_HOME"


# Verify Java is working
if ! command -v java >/dev/null 2>&1; then
    echo "ERROR: Java command not available after setup"
    exit 1
fi

echo "✓ Java version: $(java -version 2>&1 | head -1)"

# Start the application
echo "[RUN-REPLIT] Starting Spring Boot application..."
java -jar "$JAR_FILE" --server.port=5000