#!/bin/bash

# Simple run script for Replit deployment
# This is the entry point for the application

set -e

echo "=== Twitch Chat Reader Deployment ==="
echo "Timestamp: $(date)"

# FIX 1: Use direct Java path instead of complex detection
log "Setting up Java environment..."
if [ -d "/nix/store" ]; then
    # Use direct Nix store path pattern - much faster than complex searches
    JAVA_HOME=$(ls -d /nix/store/*jdk* 2>/dev/null | head -1)
    if [ -n "$JAVA_HOME" ] && [ -f "$JAVA_HOME/bin/java" ]; then
        export JAVA_HOME
        export PATH="$JAVA_HOME/bin:$PATH"
        log "✓ Java found at: $JAVA_HOME"
    else
        log "ERROR: No Java installation found in Nix store"
        exit 1
    fi
else
    # Fallback for non-Nix environments
    if command -v java >/dev/null 2>&1; then
        JAVA_HOME=$(dirname $(dirname $(readlink -f $(which java))))
        export JAVA_HOME
        log "✓ Using system Java: $JAVA_HOME"
    else
        log "ERROR: No Java installation found"
        exit 1
    fi
fi

echo "✓ Java environment set: $JAVA_HOME"


# Verify Java is working
if ! command -v java >/dev/null 2>&1; then
    echo "ERROR: Java command not available after setup"
    exit 1
fi

echo "✓ Java version: $(java -version 2>&1 | head -1)"

# Start the application
echo "[RUN-REPLIT] Starting Spring Boot application..."
java -jar "$JAR_FILE" --server.port=5000