#!/bin/bash

# Optimized run command for Spring Boot Twitch Chat Reader
# Compatible with both Autoscale and Reserved VM deployment types

set -e  # Exit on any error

echo "=== Spring Boot Twitch Chat Reader - Deployment ==="

# Set up Java environment for Replit
export JAVA_HOME=$(ls -d /nix/store/*jdk* | head -1 2>/dev/null || echo "/usr/lib/jvm/java-11-openjdk")
export PATH=$JAVA_HOME/bin:$PWD/maven/bin:$PATH

# Use PORT environment variable if available (Autoscale), otherwise default to 5000
export SERVER_PORT=${PORT:-5000}
export SPRING_PROFILES_ACTIVE=production

echo "Deployment Configuration:"
echo "- Java Home: $JAVA_HOME"
echo "- Server Port: $SERVER_PORT"
echo "- Spring Profile: $SPRING_PROFILES_ACTIVE"

# Build the application (skip tests for faster deployment)
echo "Building application..."
mvn clean package -DskipTests -Dmaven.test.skip=true -q

# Check if JAR was built successfully
JAR_FILE="target/twitch-chat-reader-1.0.0.jar"
if [ ! -f "$JAR_FILE" ]; then
    echo "ERROR: JAR file not found at $JAR_FILE"
    exit 1
fi

echo "JAR built successfully. Starting application..."

# Start with optimized JVM settings for web deployment
exec java \
    -Xmx512m \
    -Xms256m \
    -XX:+UseG1GC \
    -XX:MaxGCPauseMillis=200 \
    -Dserver.port=$SERVER_PORT \
    -Dspring.profiles.active=$SPRING_PROFILES_ACTIVE \
    -Djava.security.egd=file:/dev/./urandom \
    -jar "$JAR_FILE"