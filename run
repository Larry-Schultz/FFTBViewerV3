#!/bin/bash

# Simple run script for Replit deployment
# This is the entry point for the application

set -e

LOG_PREFIX="[RUN]"
log() {
    echo "$LOG_PREFIX $1" >&2
}

log "=== Spring Boot Deployment Build ==="
log "Timestamp: $(date)"

echo "=== Twitch Chat Reader Deployment ==="
echo "Timestamp: $(date)"


# Check if JAVA_HOME is populated
if [ -z "$JAVA_HOME" ]; then
    log "ERROR: JAVA_HOME not set"
    
    log "Java not found, attempting to download"
    if command -v apt-get >/dev/null 2>&1; then
        sudo apt-get update -y
        sudo apt-get install openjdk-11-jdk -y
        export JAVA_HOME="$(dirname $(dirname $(readlink -f $(which javac))))"
        log "Java installed and JAVA_HOME set: $JAVA_HOME"
    else
        log "ERROR: Could not detect package manager. Please set JAVA_HOME manually."
        exit 1
    fi
fi


echo "✓ Java environment set: $JAVA_HOME"


# Verify Java is working
if ! command -v java >/dev/null 2>&1; then
    echo "ERROR: Java command not available after setup"
    exit 1
fi

echo "✓ Java version: $(java -version 2>&1 | head -1)"

# Start the application
echo "[RUN-REPLIT] Starting Spring Boot application..."
java -jar "$JAR_FILE" --server.port=5000