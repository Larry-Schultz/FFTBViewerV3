#!/bin/bash

# Simple run script for Replit deployment
# This is the entry point for the application

set -e

echo "=== Twitch Chat Reader Deployment ==="
echo "Timestamp: $(date)"

# FIX 1: Use direct Java path instead of complex detection
log "Setting up Java environment..."
if [ -d "/nix/store" ]; then
    # Use direct Nix store path pattern - much faster than complex searches
    JAVA_HOME=$(ls -d /nix/store/*jdk* 2>/dev/null | head -1)
    if [ -n "$JAVA_HOME" ] && [ -f "$JAVA_HOME/bin/java" ]; then
        export JAVA_HOME
        export PATH="$JAVA_HOME/bin:$PATH"
        log "✓ Java found at: $JAVA_HOME"
    else
        log "ERROR: No Java installation found in Nix store"
        exit 1
    fi
else
    # Fallback for non-Nix environments
    if command -v java >/dev/null 2>&1; then
        JAVA_HOME=$(dirname $(dirname $(readlink -f $(which java))))
        export JAVA_HOME
        log "✓ Using system Java: $JAVA_HOME"
    else
        log "ERROR: No Java installation found"
        exit 1
    fi
fi

echo "✓ Java environment set: $JAVA_HOME"


# Verify Java is working
if ! command -v java >/dev/null 2>&1; then
    echo "ERROR: Java command not available after setup"
    exit 1
fi

echo "✓ Java version: $(java -version 2>&1 | head -1)"

# Check if we have a JAR file - if so, use emergency runner
JAR_FILE=$(find target -name "*.jar" -not -name "*sources.jar" 2>/dev/null | head -1)

if [ -n "$JAR_FILE" ] && [ -f "$JAR_FILE" ]; then
    echo "JAR found, using emergency direct execution..."
    chmod +x deployment/emergency-run.sh 2>/dev/null || true
    exec bash deployment/emergency-run.sh
else
    echo "No JAR found, using complete deployment with build..."
    chmod +x deployment/deploy-complete.sh 2>/dev/null || true
    exec bash deployment/deploy-complete.sh
fi